<!doctype html>
<html>
    <head>
        <title>Home</title>
    </head>
    <link
        rel="stylesheet"
        href="styles.css"
    />
    <body>
        <h2>Photo Gallery</h2>

        <form id="uploadForm">
            <input
                type="file"
                id="photo"
                required
            />
            <button type="submit">Upload</button>
        </form>

        <h3>Your Uploaded Photos</h3>

        <!-- Search input -->
        <input
            type="text"
            id="searchInput"
            placeholder="Search by filename"
            style="margin-bottom: 10px; padding: 5px; width: 250px"
        />

        <div
            id="photoList"
            style="display: flex; flex-wrap: wrap"
        ></div>

        <br />
        <button onclick="logout()">Logout</button>

        <script>
            if (!localStorage.userId) location.href = 'login.html';

            let allPhotos = [];

            async function fetchPhotos() {
                const res = await fetch(`/photos?userId=${localStorage.userId}`);
                allPhotos = await res.json();
                renderPhotos(allPhotos);
            }

            function renderPhotos(photos) {
                const list = document.getElementById('photoList');
                list.innerHTML = '';

                for (const photo of photos) {
                    const container = document.createElement('div');
                    container.style.margin = '10px';
                    container.style.textAlign = 'center';

                    const img = document.createElement('img');
                    img.src = `/download/${photo.id}`;
                    img.alt = photo.filename;
                    img.style.width = '200px';
                    img.style.border = '1px solid #ccc';
                    img.style.display = 'block';
                    img.style.marginBottom = '5px';

                    const btn = document.createElement('button');
                    btn.textContent = 'Download';
                    btn.onclick = () => {
                        const link = document.createElement('a');
                        link.href = `/download/${photo.id}`;
                        link.download = photo.filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };

                    container.appendChild(img);
                    container.appendChild(btn);
                    list.appendChild(container);
                }
            }

            document.getElementById('searchInput').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allPhotos.filter((p) => p.filename.toLowerCase().includes(query));
                renderPhotos(filtered);
            };

            document.getElementById('uploadForm').onsubmit = async (e) => {
                e.preventDefault();
                const file = document.getElementById('photo').files[0];
                if (!file) return alert('Choose a file');
                const buf = await file.arrayBuffer();
                const res = await fetch(`/upload?userId=${localStorage.userId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/octet-stream'},
                    body: buf
                });
                alert(await res.text());
                await fetchPhotos();
            };

            function logout() {
                localStorage.removeItem('userId');
                location.href = 'login.html';
            }

            fetchPhotos();
        </script>
    </body>
</html>
